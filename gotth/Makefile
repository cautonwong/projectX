.PHONY: dev build generate tailwind-install tailwind-watch tailwind-build run-all

# ==============================================================================
# Go Commands
# ==============================================================================

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (å¸¦çƒ­é‡è½½)
dev:
	@echo "ğŸ”¥ Starting Go dev server with Air..."
	@air

# æ„å»ºç”Ÿäº§ç¯å¢ƒäºŒè¿›åˆ¶æ–‡ä»¶
build: tailwind-build
	@echo "ğŸ“¦ Building Go binary for production..."
	@templ generate
	@go build -o ./bin/app ./cmd/app

# ç”Ÿæˆ Templ å’Œ sqlc (å¦‚æœéœ€è¦)
generate:
	@echo "âœ¨ Generating Templ components..."
	@templ generate
	@echo "âœ¨ Generating sqlc code..."
	@sqlc generate

# ==============================================================================
# Frontend Commands
# ==============================================================================

# å®‰è£… npm å¼€å‘ä¾èµ–
npm-install:
	@echo "Installing npm dev dependencies..."
	@npm install

# (å¼€å‘) ç¼–è¯‘å¹¶ç›‘å¬ CSS
tailwind-watch:
	@echo "ğŸ¨ Watching for CSS changes..."
	@npm run css:dev

# (ç”Ÿäº§) æ„å»ºå¹¶å‹ç¼© CSS
tailwind-build:
	@echo "ğŸ¨ Building and minifying CSS..."
	@npm run css:build

# ==============================================================================
# Helper Commands
# ==============================================================================

# è¿è¡Œæ‰€æœ‰å¼€å‘è¿›ç¨‹ (éœ€è¦ concurrently)
# npm install -g concurrently
run-all-dev:
	@concurrently "make dev" "make tailwind-watch"

# åˆå§‹åŒ–é¡¹ç›®ä¾èµ–
setup: npm-install
	@echo "âœ… Project setup complete. Run 'make dev' and 'make tailwind-watch' in separate terminals."

install-tools:
	@echo "ğŸ› ï¸  Installing Go development tools..."
	@go install github.com/air-verse/air@latest
	@go install github.com/a-h/templ/cmd/templ@latest
	@go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
	@go install -tags 'sqlite' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "âœ… Go tools installed."

# ==============================================================================
# Database Commands
# ==============================================================================

# åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
db-migration:
    @read -p "Enter migration name: " name; \
    migrate create -ext sql -dir db/migrations -seq $$name

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
db-migrate:
	@echo "ğŸ”„ Running database migrations..."
	@migrate -path db/migrations -database "sqlite3://app.db" up

# å›æ»šæœ€åä¸€æ¬¡è¿ç§»
db-rollback:
	@echo "âª Rolling back the last migration..."
	@migrate -path db/migrations -database "sqlite3://app.db" down 1

# å›æ»šæ‰€æœ‰è¿ç§»
db-reset:
	@echo "ğŸ—‘ï¸  Rolling back all migrations..."
	@migrate -path db/migrations -database "sqlite3://app.db" down

db-seed:
	@echo "ğŸŒ± Seeding database..."
	@go run ./scripts/seed/main.go